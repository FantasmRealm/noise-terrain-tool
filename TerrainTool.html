<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godotåœ°å½¢é«˜åº¦å›¾&æ¨¡å‹ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            min-height: 100vh;
            position: relative; /* ä¸ºGitHubæŒ‰é’®å®šä½åšå‡†å¤‡ */
            transition: all 0.3s ease; /* é€‚é…åˆ‡æ¢åŠ¨ç”» */
        }

        /* ========== ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯åˆ‡æ¢æ ·å¼ ========== */
        body.mobile-mode {
            flex-direction: column;
        }
        body.mobile-mode .sidebar {
            width: 100%;
            height: auto;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        body.mobile-mode .main-container {
            margin-left: 0;
            max-width: 100%;
            padding: 10px;
        }
        body.mobile-mode .content-wrapper {
            max-height: calc(100vh - 120px);
        }
        body.mobile-mode .tab {
            text-align: center;
        }
        body.mobile-mode .github-btn {
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
        }

        /* åˆ‡æ¢æ¨¡å¼æµ®åŠ¨æŒ‰é’® */
        .mode-toggle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #673AB7, #512DA8);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(103, 58, 183, 0.4);
            transition: all 0.3s ease;
            z-index: 30;
            border: none;
            font-size: 20px;
        }
        .mode-toggle-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 18px rgba(103, 58, 183, 0.5);
        }
        .mode-toggle-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* ========== å·¦ä¾§ä¾§è¾¹æ ä¼˜åŒ– ========== */
        .sidebar {
            width: 220px;
            background: linear-gradient(180deg, #2c3e50, #1a252f); /* æ¸å˜èƒŒæ™¯å¢åŠ å±‚æ¬¡æ„Ÿ */
            color: white;
            padding: 20px 0;
            height: 100vh;
            position: fixed;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15); /* ä¾§è¾¹é˜´å½±å¢åŠ ç«‹ä½“æ„Ÿ */
            z-index: 10;
            transition: all 0.3s ease;
        }
        .sidebar h1 {
            font-size: 18px;
            text-align: center;
            padding: 0 15px 20px;
            border-bottom: 1px solid #444;
            margin-bottom: 20px;
            color: #ecf0f1;
        }
        
        /* åˆ‡æ¢æŒ‰é’®ä¼˜åŒ– - å¢åŠ å±‚æ¬¡æ„Ÿ */
        .tab {
            display: block;
            width: 100%;
            padding: 15px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 16px;
            color: #ecf0f1;
            text-align: left;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        /* æŒ‰é’®hoveræ•ˆæœ */
        .tab:hover {
            background: #34495e;
            transform: translateX(4px); /* è½»å¾®å³ç§»å¢åŠ åŠ¨æ„Ÿ */
        }
        /* æ¿€æ´»æŒ‰é’®æ ·å¼ */
        .tab.active {
            background: linear-gradient(90deg, #4CAF50, #43a047); /* æ¸å˜èƒŒæ™¯ */
            color: white;
            border-left: 4px solid #2ecc71;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.2); /* å†…é˜´å½±å¢åŠ æŒ‰å‹æ„Ÿ */
        }
        /* æŒ‰é’®ä¼ªå…ƒç´ å¢åŠ å±‚æ¬¡æ„Ÿ */
        .tab::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.05);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .tab:hover::after {
            transform: translateX(0);
        }

        /* ========== GitHubæŒ‰é’® - å·¦ä¸‹è§’ ========== */
        .github-btn {
            position: fixed;
            bottom: 30px;
            left: 20px;
            background: linear-gradient(135deg, #333, #444);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 20;
            width: 180px;
            justify-content: center;
        }
        .github-btn:hover {
            background: linear-gradient(135deg, #444, #555);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.3);
        }
        .github-btn svg {
            width: 18px;
            height: 18px;
            fill: white;
        }

        /* ========== å³ä¾§ä¸»å†…å®¹åŒº ========== */
        .main-container {
            flex: 1;
            margin-left: 220px;
            padding: 20px;
            max-width: calc(100% - 220px);
            transition: all 0.3s ease;
        }
        .content-wrapper {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        .controls {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #43a047);
            color: white;
            border: none;
            cursor: pointer;
            padding: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(76, 175, 80, 0.2);
        }
        button:hover {
            background: linear-gradient(135deg, #388e3c, #43a047);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.3);
        }
        #canvas-container {
            text-align: center;
            margin-top: 20px;
            max-height: 400px;
            overflow: hidden;
        }
        canvas {
            border: 1px solid #ddd;
            max-width: 100%;
            max-height: 400px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .download-btn {
            background: linear-gradient(135deg, #2196F3, #1976d2);
            box-shadow: 0 3px 6px rgba(33, 150, 243, 0.2);
            margin-top: 10px;
        }
        .download-btn:hover {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            box-shadow: 0 6px 12px rgba(33, 150, 243, 0.3);
        }
        .tips {
            margin-top: 20px;
            padding: 10px;
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #image-upload {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s ease;
        }
        #image-upload:hover {
            border-color: #4CAF50;
            background-color: #f9fef9;
        }
        #model-format {
            margin: 10px 0;
        }
        .loading {
            color: #2196F3;
            font-weight: bold;
            margin-top: 10px;
        }
        .tab-content {
            display: none;
            padding: 10px 0;
            animation: fadeIn 0.4s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å“åº”å¼é€‚é…ï¼ˆå¤‡ç”¨ï¼‰ */
        @media (max-width: 768px) {
            .mode-toggle-btn {
                bottom: 90px;
            }
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <div class="sidebar">
        <h1>Godotåœ°å½¢ç”Ÿæˆå™¨</h1>
        <button class="tab active" onclick="openTab('generator')">é«˜åº¦å›¾ç”Ÿæˆ</button>
        <button class="tab" onclick="openTab('modeler')">æ¨¡å‹ç”Ÿæˆï¼ˆè¯†åˆ«é«˜åº¦å›¾ï¼‰</button>
    </div>

    <!-- GitHubè·³è½¬æŒ‰é’® -->
    <a href="https://github.com/FantasmRealm/noise-terrain-tool" target="_blank" class="github-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        è®¿é—®GitHubä»“åº“
    </a>

    <!-- ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯åˆ‡æ¢æŒ‰é’® -->
    <button class="mode-toggle-btn" id="modeToggleBtn" title="åˆ‡æ¢ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯">ğŸ“±</button>

    <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <div class="content-wrapper">
            <!-- é«˜åº¦å›¾ç”Ÿæˆæ ‡ç­¾é¡µ -->
            <div id="generator" class="tab-content active">
                <div class="controls">
                    <div class="control-group">
                        <label for="width">å›¾ç‰‡å®½åº¦ï¼ˆåƒç´ ï¼‰</label>
                        <input type="number" id="width" value="512" min="64" max="2048">
                    </div>
                    <div class="control-group">
                        <label for="height">å›¾ç‰‡é«˜åº¦ï¼ˆåƒç´ ï¼‰</label>
                        <input type="number" id="height" value="512" min="64" max="2048">
                    </div>
                    <div class="control-group">
                        <label for="scale">å™ªæ³¢ç¼©æ”¾ï¼ˆè¶Šå°è¶Šç²¾ç»†ï¼‰</label>
                        <input type="number" id="scale" value="20" min="1" max="100" step="0.5">
                    </div>
                    <div class="control-group">
                        <label for="octaves">ç»†èŠ‚å±‚æ•°ï¼ˆè¶Šå¤šè¶Šå¤æ‚ï¼‰</label>
                        <input type="number" id="octaves" value="4" min="1" max="8">
                    </div>
                    <button id="generate-btn">ç”Ÿæˆé«˜åº¦å›¾</button>
                </div>

                <div id="canvas-container">
                    <canvas id="heightmap-canvas"></canvas>
                    <br>
                    <button id="download-heightmap-btn" class="download-btn" style="display: none;">ä¸‹è½½PNGé«˜åº¦å›¾</button>
                </div>
            </div>

            <!-- æ¨¡å‹ç”Ÿæˆæ ‡ç­¾é¡µ -->
            <div id="modeler" class="tab-content">
                <div class="control-group">
                    <label>ä¸Šä¼ é«˜åº¦å›¾ï¼ˆé»‘ç™½/ç°åº¦PNGï¼‰</label>
                    <div id="image-upload">
                        <input type="file" id="heightmap-upload" accept="image/png,image/jpg,image/jpeg">
                        <p id="upload-status">æœªä¸Šä¼ å›¾ç‰‡</p>
                    </div>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <label for="height-scale">åœ°å½¢é«˜åº¦ç¼©æ”¾ï¼ˆå€¼è¶Šå¤§è¶Šé«˜ï¼‰</label>
                        <input type="number" id="height-scale" value="20" min="1" max="200" step="0.5">
                    </div>
                    <div class="control-group">
                        <label for="mesh-scale">å¹³é¢ç¼©æ”¾ï¼ˆX/Zè½´ï¼‰</label>
                        <input type="number" id="mesh-scale" value="0.1" min="0.01" max="1" step="0.01">
                    </div>
                    <div class="control-group">
                        <label for="model-format">å¯¼å‡ºæ¨¡å‹æ ¼å¼</label>
                        <select id="model-format">
                            <option value="obj">OBJï¼ˆé€šç”¨ï¼Œæ¨èï¼‰</option>
                            <option value="glb">GLBï¼ˆGodotä¼˜åŒ–ï¼Œå¸¦æè´¨ï¼‰</option>
                            <option value="gltf">glTFï¼ˆJSONæ ¼å¼ï¼Œè·¨å¼•æ“ï¼‰</option>
                            <option value="fbx">FBXï¼ˆAutodeskæ ¼å¼ï¼ŒUnity/3dsMaxï¼‰</option>
                            <option value="dae">DAE/Colladaï¼ˆXMLæ ¼å¼ï¼Œé€šç”¨ï¼‰</option>
                        </select>
                    </div>
                    <button id="generate-model-btn" disabled>ç”Ÿæˆå¹¶ä¸‹è½½3Dæ¨¡å‹</button>
                </div>

                <div id="model-preview-container">
                    <canvas id="model-preview-canvas"></canvas>
                    <div id="loading-indicator" class="loading" style="display: none;">æ­£åœ¨ç”Ÿæˆæ¨¡å‹ï¼Œè¯·ç¨å€™...</div>
                </div>
            </div>

            <div class="tips">
                <h3>æ ¸å¿ƒè§„åˆ™ & Godotä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li>âœ… ç™½è‰²åŒºåŸŸï¼ˆç°åº¦255ï¼‰= æœ€é«˜åœ°å½¢ï¼ˆè‰åœ°ç»¿ï¼‰ï¼Œé»‘è‰²åŒºåŸŸï¼ˆç°åº¦0ï¼‰= æœ€ä½åœ°å½¢ï¼ˆåœŸåœ°æ£•ï¼‰</li>
                    <li>âœ… ç”Ÿæˆçš„æ¨¡å‹å¯ç›´æ¥æ‹–æ‹½åˆ°Godotç­‰æ¸¸æˆå¼•æ“ï¼Œä¼šè‡ªåŠ¨è¯†åˆ«ç½‘æ ¼ä½“</li>
                    <li>âœ… æ¨èå°ºå¯¸ï¼š256x256ï¼ˆå¹³è¡¡æ€§èƒ½å’Œç»†èŠ‚ï¼‰ï¼Œé«˜åº¦ç¼©æ”¾20-50ï¼ˆåœ°å½¢èµ·ä¼é€‚ä¸­ï¼‰</li>
                    <li>âŒ é¿å…ä½¿ç”¨2048x2048è¶…å¤§å°ºå¯¸ï¼Œä¼šå¯¼è‡´æ¨¡å‹é¢æ•°è¿‡å¤šï¼ˆç™¾ä¸‡çº§ï¼‰ï¼ŒGodotåŠ è½½å¡é¡¿</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Three.jså’Œå„ç±»å¯¼å‡ºä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/exporters/GLBExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/exporters/GLTFExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/exporters/FBXExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/exporters/ColladaExporter.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/utils/BufferGeometryUtils.js"></script>

    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function openTab(tabName) {
            const tabs = document.getElementsByClassName("tab");
            const tabContents = document.getElementsByClassName("tab-content");
            
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
                tabContents[i].classList.remove("active");
            }
            
            event.currentTarget.classList.add("active");
            document.getElementById(tabName).classList.add("active");
        }

        // ========== ç§»åŠ¨ç«¯/æ¡Œé¢ç«¯åˆ‡æ¢åŠŸèƒ½ ==========
        const modeToggleBtn = document.getElementById('modeToggleBtn');
        let isMobileMode = false;

        // åˆå§‹åŒ–ï¼šæ£€æµ‹å±å¹•å°ºå¯¸è‡ªåŠ¨é€‚é…
        function initMode() {
            if (window.innerWidth <= 768) {
                toggleMode();
            }
        }

        // åˆ‡æ¢æ¨¡å¼æ ¸å¿ƒå‡½æ•°
        function toggleMode() {
            isMobileMode = !isMobileMode;
            document.body.classList.toggle('mobile-mode', isMobileMode);
            
            // æ›´æ–°æŒ‰é’®å›¾æ ‡å’Œæç¤º
            if (isMobileMode) {
                modeToggleBtn.innerHTML = 'ğŸ–¥ï¸';
                modeToggleBtn.title = 'åˆ‡æ¢åˆ°æ¡Œé¢ç«¯';
            } else {
                modeToggleBtn.innerHTML = 'ğŸ“±';
                modeToggleBtn.title = 'åˆ‡æ¢åˆ°ç§»åŠ¨ç«¯';
            }
        }

        // ç»‘å®šåˆ‡æ¢äº‹ä»¶
        modeToggleBtn.addEventListener('click', toggleMode);
        // çª—å£å¤§å°å˜åŒ–æ—¶è‡ªåŠ¨é€‚é…
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768 && !isMobileMode) {
                toggleMode();
            } else if (window.innerWidth > 768 && isMobileMode) {
                toggleMode();
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¨¡å¼
        window.addEventListener('load', initMode);

        // ===================== 1. é«˜åº¦å›¾ç”Ÿæˆæ ¸å¿ƒï¼ˆä¼˜åŒ–å‘½åï¼‰ =====================
        class SimplePerlin {
            constructor(seed = Math.random()) {
                this.seed = seed;
                this.p = [];
                for (let i = 0; i < 256; i++) {
                    this.p[i] = Math.floor(Math.random() * 256);
                }
                for (let i = 0; i < 256; i++) {
                    this.p[256 + i] = this.p[i];
                }
            }

            fade(t) {
                return t * t * t * (t * (t * 6 - 15) + 10);
            }

            lerp(t, a, b) {
                return a + t * (b - a);
            }

            grad(hash, x, y) {
                const h = hash & 15;
                const u = h < 8 ? x : y;
                const v = h < 4 ? y : h === 12 || h === 14 ? x : 0;
                return ((h & 1) === 0 ? u : -u) + ((h & 2) === 0 ? v : -v);
            }

            noise(x, y) {
                const X = Math.floor(x) & 255;
                const Y = Math.floor(y) & 255;
                
                x -= Math.floor(x);
                y -= Math.floor(y);
                
                const u = this.fade(x);
                const v = this.fade(y);
                
                const A = this.p[X] + Y;
                const B = this.p[X + 1] + Y;
                
                return this.lerp(v, 
                    this.lerp(u, this.grad(this.p[A], x, y), this.grad(this.p[B], x-1, y)),
                    this.lerp(u, this.grad(this.p[A+1], x, y-1), this.grad(this.p[B+1], x-1, y-1))
                );
            }

            fbm(x, y, octaves = 4) {
                let total = 0;
                let frequency = 1;
                let amplitude = 1;
                let maxValue = 0;
                
                for (let i = 0; i < octaves; i++) {
                    total += this.noise(x * frequency, y * frequency) * amplitude;
                    maxValue += amplitude;
                    amplitude *= 0.5;
                    frequency *= 2;
                }
                
                return total / maxValue;
            }
        }

        // é«˜åº¦å›¾ç”Ÿæˆé€»è¾‘
        const generateBtn = document.getElementById('generate-btn');
        const downloadHeightmapBtn = document.getElementById('download-heightmap-btn');
        const heightmapCanvas = document.getElementById('heightmap-canvas');
        const ctx = heightmapCanvas.getContext('2d');

        function generateHeightmap() {
            const width = parseInt(document.getElementById('width').value) || 512;
            const height = parseInt(document.getElementById('height').value) || 512;
            const scale = parseFloat(document.getElementById('scale').value) || 20;
            const octaves = parseInt(document.getElementById('octaves').value) || 4;

            heightmapCanvas.width = width;
            heightmapCanvas.height = height;

            const perlin = new SimplePerlin();
            const imageData = ctx.createImageData(width, height);
            const data = imageData.data;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    // ç”Ÿæˆå™ªæ³¢å€¼ï¼ˆ-1 ~ 1ï¼‰â†’ è½¬æ¢ä¸º0~255ç°åº¦
                    const noiseValue = perlin.fbm(x / scale, y / scale, octaves);
                    const gray = Math.floor(((noiseValue + 1) / 2) * 255);
                    const clampedGray = Math.max(0, Math.min(255, gray));
                    
                    // èµ‹å€¼ç»™åƒç´ ï¼ˆç°åº¦å›¾ï¼šR=G=Bï¼‰
                    const index = (y * width + x) * 4;
                    data[index] = clampedGray;     // R
                    data[index + 1] = clampedGray; // G
                    data[index + 2] = clampedGray; // B
                    data[index + 3] = 255;         // A
                }
            }

            ctx.putImageData(imageData, 0, 0);
            downloadHeightmapBtn.style.display = 'block';
        }

        // ä¼˜åŒ–é«˜åº¦å›¾ä¸‹è½½å‘½åï¼ˆåœ°å½¢å™ªæ³¢å›¾ï¼‰
        function downloadHeightmap() {
            const link = document.createElement('a');
            // ä¿®æ­£å‘½åï¼šåœ°å½¢å™ªæ³¢å›¾ + å°ºå¯¸ + æ—¶é—´æˆ³
            const width = heightmapCanvas.width;
            const height = heightmapCanvas.height;
            link.download = `åœ°å½¢å™ªæ³¢å›¾_${width}x${height}_${Date.now()}.png`;
            link.href = heightmapCanvas.toDataURL('image/png');
            link.click();
        }

        generateBtn.addEventListener('click', generateHeightmap);
        downloadHeightmapBtn.addEventListener('click', downloadHeightmap);
        generateHeightmap(); // åˆå§‹ç”Ÿæˆ

        // ===================== 2. å¤šæ ¼å¼æ¨¡å‹ç”Ÿæˆæ ¸å¿ƒ =====================
        const heightmapUpload = document.getElementById('heightmap-upload');
        const uploadStatus = document.getElementById('upload-status');
        const generateModelBtn = document.getElementById('generate-model-btn');
        const modelPreviewCanvas = document.getElementById('model-preview-canvas');
        const loadingIndicator = document.getElementById('loading-indicator');
        let uploadedImage = null;

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        heightmapUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                uploadStatus.textContent = 'âŒ è¯·ä¸Šä¼ PNG/JPGæ ¼å¼çš„å›¾ç‰‡ï¼';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    uploadedImage = img;
                    uploadStatus.textContent = `âœ… å·²ä¸Šä¼ ï¼š${file.name} (${img.width}x${img.height})`;
                    generateModelBtn.disabled = false;
                    
                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆï¼ˆç¼©æ”¾åˆ°400pxå†…ï¼‰
                    modelPreviewCanvas.width = Math.min(400, img.width);
                    modelPreviewCanvas.height = Math.min(400, img.height);
                    const modelCtx = modelPreviewCanvas.getContext('2d');
                    modelCtx.drawImage(img, 0, 0, modelPreviewCanvas.width, modelPreviewCanvas.height);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // ç”ŸæˆåŸºç¡€ç½‘æ ¼ï¼ˆä¾›å„æ ¼å¼å¯¼å‡ºä½¿ç”¨ï¼‰
        function createTerrainMesh(width, height, heightData, heightScale, meshScale) {
            // åˆ›å»ºå¹³é¢å‡ ä½•ä½“ï¼ˆåˆ†æ®µæ•°=åƒç´ æ•°-1ï¼Œä¿è¯æ¯ä¸ªåƒç´ å¯¹åº”ä¸€ä¸ªé¡¶ç‚¹ï¼‰
            const geometry = new THREE.PlaneGeometry(
                width * meshScale, 
                height * meshScale, 
                width - 1, 
                height - 1
            );

            // è°ƒæ•´é¡¶ç‚¹é«˜åº¦
            const positions = geometry.attributes.position;
            const colors = [];
            const color = new THREE.Color();

            for (let i = 0; i < positions.count; i++) {
                // è®¡ç®—å¯¹åº”å›¾ç‰‡åƒç´ åæ ‡
                const vertexIndex = i;
                const x = vertexIndex % width;
                const z = Math.floor(vertexIndex / width);
                const grayValue = heightData[z * width + x];
                const yHeight = (grayValue / 255) * heightScale;

                // è®¾ç½®Yè½´é«˜åº¦
                positions.setY(i, yHeight);

                // ç”Ÿæˆæ¸å˜é¢œè‰²ï¼šä½=æ£•è‰²ï¼Œé«˜=ç»¿è‰²
                const heightRatio = grayValue / 255;
                color.setRGB(
                    0.2 + heightRatio * 0.1, // R: 0.2~0.3
                    0.4 + heightRatio * 0.5, // G: 0.4~0.9
                    0.1 + heightRatio * 0.1  // B: 0.1~0.2
                );
                colors.push(color.r, color.g, color.b);
            }

            // æ·»åŠ é¢œè‰²å±æ€§
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.computeVertexNormals();

            // åˆ›å»ºæè´¨
            const material = new THREE.MeshStandardMaterial({
                vertexColors: true,
                roughness: 0.8,
                metalness: 0.1
            });

            // åˆ›å»ºç½‘æ ¼
            const mesh = new THREE.Mesh(geometry, material);
            mesh.rotation.x = -Math.PI / 2; // æ—‹è½¬åˆ°æ­£ç¡®æ–¹å‘
            mesh.position.set(0, 0, 0);
            
            return mesh;
        }

        // 1. OBJæ ¼å¼å¯¼å‡ºï¼ˆé€šç”¨æ–‡æœ¬æ ¼å¼ï¼‰
        function generateOBJ(width, height, heightData, heightScale, meshScale) {
            let objContent = `# Godot Terrain Heightmap Model\n# Generated by noise-terrain-tool\n# White = High (Grass), Black = Low (Dirt)\n`;
            let vertexCount = 0;

            // ç”Ÿæˆé¡¶ç‚¹ï¼ˆVï¼šx, y, zï¼‰
            for (let z = 0; z < height; z++) {
                for (let x = 0; x < width; x++) {
                    const grayValue = heightData[z * width + x];
                    const yHeight = (grayValue / 255) * heightScale;
                    
                    const worldX = (x - width/2) * meshScale;
                    const worldZ = (z - height/2) * meshScale;
                    
                    objContent += `v ${worldX.toFixed(4)} ${yHeight.toFixed(4)} ${worldZ.toFixed(4)}\n`;
                    vertexCount++;
                }
            }

            // ç”Ÿæˆé¢ï¼ˆFï¼šä¸‰è§’é¢ï¼Œé¡ºæ—¶é’ˆï¼‰
            objContent += `# Faces (Triangles)\n`;
            for (let z = 0; z < height - 1; z++) {
                for (let x = 0; x < width - 1; x++) {
                    const v1 = z * width + x + 1;
                    const v2 = (z + 1) * width + x + 1;
                    const v3 = (z + 1) * width + (x + 1) + 1;
                    const v4 = z * width + (x + 1) + 1;
                    
                    objContent += `f ${v1} ${v2} ${v3}\n`;
                    objContent += `f ${v1} ${v3} ${v4}\n`;
                }
            }

            return new Blob([objContent], { type: 'text/plain' });
        }

        // 2. GLBæ ¼å¼å¯¼å‡ºï¼ˆäºŒè¿›åˆ¶glTFï¼Œå¸¦æè´¨ï¼‰
        function generateGLB(mesh) {
            return new Promise((resolve) => {
                const exporter = new THREE.GLBExporter();
                exporter.parse(mesh, (glb) => {
                    const blob = new Blob([glb], { type: 'model/gltf-binary' });
                    resolve(blob);
                }, { binary: true });
            });
        }

        // 3. glTFæ ¼å¼å¯¼å‡ºï¼ˆJSONæ ¼å¼ï¼Œå¼€æºæ ‡å‡†ï¼‰
        function generateGLTF(mesh) {
            return new Promise((resolve) => {
                const exporter = new THREE.GLTFExporter();
                exporter.parse(mesh, (gltf) => {
                    const json = JSON.stringify(gltf, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    resolve(blob);
                }, { 
                    trs: false,
                    onlyVisible: true,
                    truncateDrawRange: true,
                    embedImages: true,
                    binary: false
                });
            });
        }

        // 4. FBXæ ¼å¼å¯¼å‡ºï¼ˆAutodeskæ ¼å¼ï¼Œé€‚é…Unity/3dsMaxï¼‰
        function generateFBX(mesh) {
            return new Promise((resolve) => {
                const exporter = new THREE.FBXExporter();
                const fbxData = exporter.parse(mesh);
                const blob = new Blob([fbxData], { type: 'application/octet-stream' });
                resolve(blob);
            });
        }

        // 5. DAE/Colladaæ ¼å¼å¯¼å‡ºï¼ˆXMLé€šç”¨æ ¼å¼ï¼‰
        function generateDAE(mesh) {
            return new Promise((resolve) => {
                const exporter = new THREE.ColladaExporter();
                const daeData = exporter.parse(mesh);
                const blob = new Blob([daeData], { type: 'application/xml' });
                resolve(blob);
            });
        }

        // æ¨¡å‹ç”Ÿæˆä¸»å‡½æ•°
        generateModelBtn.addEventListener('click', async function() {
            if (!uploadedImage) return;

            loadingIndicator.style.display = 'block';
            generateModelBtn.disabled = true;

            try {
                // è·å–å‚æ•°
                const heightScale = parseFloat(document.getElementById('height-scale').value) || 20;
                const meshScale = parseFloat(document.getElementById('mesh-scale').value) || 0.1;
                const modelFormat = document.getElementById('model-format').value;

                // åˆ›å»ºç”»å¸ƒè·å–åƒç´ æ•°æ®
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = uploadedImage.width;
                tempCanvas.height = uploadedImage.height;
                tempCtx.drawImage(uploadedImage, 0, 0);
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;

                // æå–ç°åº¦æ•°æ®
                const heightData = [];
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const gray = Math.floor(0.299 * r + 0.587 * g + 0.114 * b);
                    heightData.push(gray);
                }

                // ç”Ÿæˆå¯¹åº”æ ¼å¼æ¨¡å‹
                let blob, fileName;
                const timestamp = Date.now();
                const size = `${tempCanvas.width}x${tempCanvas.height}`;

                switch(modelFormat) {
                    case 'obj':
                        blob = generateOBJ(tempCanvas.width, tempCanvas.height, heightData, heightScale, meshScale);
                        fileName = `åœ°å½¢æ¨¡å‹_${size}_${timestamp}.obj`;
                        break;
                        
                    case 'glb':
                        const meshGLB = createTerrainMesh(tempCanvas.width, tempCanvas.height, heightData, heightScale, meshScale);
                        blob = await generateGLB(meshGLB);
                        fileName = `åœ°å½¢æ¨¡å‹_${size}_${timestamp}.glb`;
                        break;
                        
                    case 'gltf':
                        const meshGLTF = createTerrainMesh(tempCanvas.width, tempCanvas.height, heightData, heightScale, meshScale);
                        blob = await generateGLTF(meshGLTF);
                        fileName = `åœ°å½¢æ¨¡å‹_${size}_${timestamp}.gltf`;
                        break;
                        
                    case 'fbx':
                        const meshFBX = createTerrainMesh(tempCanvas.width, tempCanvas.height, heightData, heightScale, meshScale);
                        blob = await generateFBX(meshFBX);
                        fileName = `åœ°å½¢æ¨¡å‹_${size}_${timestamp}.fbx`;
                        break;
                        
                    case 'dae':
                        const meshDAE = createTerrainMesh(tempCanvas.width, tempCanvas.height, heightData, heightScale, meshScale);
                        blob = await generateDAE(meshDAE);
                        fileName = `åœ°å½¢æ¨¡å‹_${size}_${timestamp}.dae`;
                        break;
                }

                // ä¸‹è½½æ–‡ä»¶
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(link.href);

                uploadStatus.textContent = `âœ… æ¨¡å‹ç”ŸæˆæˆåŠŸï¼š${fileName}`;

            } catch (error) {
                uploadStatus.textContent = `âŒ ç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
                console.error('æ¨¡å‹ç”Ÿæˆé”™è¯¯ï¼š', error);
            } finally {
                loadingIndicator.style.display = 'none';
                generateModelBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
